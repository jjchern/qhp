---
output:
  md_document:
    variant: markdown_github
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

[![Travis-CI Build Status](https://travis-ci.org/jjchern/qhp.svg?branch=master)](https://travis-ci.org/jjchern/qhp)


# About

This package includes Qualified Health Plan (qhp) data in the Health Insurance Marketplace.

# Installation

```r
# install.packages("devtools")
devtools::install_github("jjchern/qhp")
```

# Links

- [ASPE AFFORDABLE CARE ACT RESEARCH](http://aspe.hhs.gov/affordable-care-act-research)
- [PLAN SELECTIONS BY ZIP CODE IN THE HEALTH INSURANCE MARKETPLACE, 2014](http://aspe.hhs.gov/plan-selections-zip-code-health-insurance-marketplace-september-2014)
- [PLAN SELECTIONS BY ZIP CODE IN THE HEALTH INSURANCE MARKETPLACE,
2015](http://aspe.hhs.gov/plan-selections-zip-code-health-insurance-marketplace-april-2015)
- [HEALTH PLAN DATASETS](https://www.healthcare.gov/health-and-dental-plan-datasets-for-researchers-and-issuers/)

## Inital Enrollment Data

- [HEALTH INSURANCE MARKETPLACE: SUMMARY ENROLLMENT REPORT FOR THE INITIAL ANNUAL OPEN ENROLLMENT PERIOD](https://aspe.hhs.gov/report/health-insurance-marketplace-summary-enrollment-report-initial-annual-open-enrollment-period)
- [ADDENDUM TO THE HEALTH INSURANCE MARKETPLACE SUMMARY ENROLLMENT REPORT FOR THE INITIAL ANNUAL OPEN ENROLLMENT PERIOD](https://aspe.hhs.gov/sites/default/files/pdf/93351/ib_2014Apr_enrollAddendum.pdf)

## Second Enrollment Data

- [QHP Selections by Age Groups](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-Age-Grou/qv54-6mtm)
- [QHP Selections by APTC](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-APTC-and/f7yt-nc7m)
- [QHP Selections by Household Incomes](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-Househol/sy6b-59wj)
- [QHP Selections by Race/ethnicity](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-Race-Eth/dvpf-jb7v)
- [QHP Selections by Types of Selections](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-Type-of-/kjvw-ka5c)
- [QHP Selections by CSR](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-CSR-and-/ncbw-vdsn)
- [QHP Selections by Metal Levels](https://data.healthcare.gov/dataset/2015-Qualifying-Health-Plan-Selections-by-Metal-Le/d89b-9897)

# Usage

## Zip Code Level Enrollment Data

```{r, message=FALSE, warning=FALSE}
library(dplyr, warn.conflicts = FALSE)
qhp::enrollment2014
qhp::enrollment2015
```

## Top 10 Counties, Sorted According to Total Enrollment

```{r, message=FALSE, warning=FALSE}
# 2014
qhp::enrollment2014 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  arrange(desc(enrollment))

# 2015
qhp::enrollment2015 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  arrange(desc(enrollment))
```

## Top 10 Counties, Sorted According to Enrollment per 10,000 Residents

```{r, message=FALSE, warning=FALSE}
# 2014
qhp::enrollment2014 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  mutate(enroll_per100000 = enrollment / copop * 10000) %>% 
  # filter(copop >= 100000) %>% 
  arrange(desc(enroll_per100000))

# 2015
qhp::enrollment2015 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  mutate(enroll_per100000 = enrollment / copop * 10000) %>% 
  # filter(copop >= 100000) %>% 
  arrange(desc(enroll_per100000))
```

## Enrolloment per 10,000 Residents by counties

```{r county-map, echo=FALSE}
# 2014
qhp::enrollment2014 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  mutate(enroll_per100000 = enrollment / copop * 10000) %>% 
  # filter(copop >= 100000) %>% 
  arrange(desc(enroll_per100000)) -> en_county_2014

# 2015
qhp::enrollment2015 %>% 
  na.omit() %>% 
  group_by(countygeoid) %>% 
  summarise(countyname = first(countyname),
            enrollment = sum(PlanSelections),
            state = first(state),
            copop = first(copop)) %>% 
  mutate(enroll_per100000 = enrollment / copop * 10000) %>% 
  # filter(copop >= 100000) %>% 
  arrange(desc(enroll_per100000)) -> en_county_2015

# devtools::install_github("jjchern/usmapdata")
en_county_2014 %>% 
  mutate(countygeoid = sprintf("%05.0f", countygeoid)) %>% 
  arrange(countygeoid) -> en_county_2014

usmapdata::county %>% 
  left_join(en_county_2014, by = c("id" = "countygeoid")) -> en_county_2014_map

library(ggplot2)

ggplot() +
  geom_map(data = en_county_2014_map, map = en_county_2014_map,
           aes(x = long, y = lat, map_id = id, fill = enroll_per100000),
           colour = alpha("white", 0.1), size=0.2) +
  geom_map(data = usmapdata::state, map = usmapdata::state,
           aes(x = long, y = lat, map_id = id),
           colour = "white", fill = "NA") +
  coord_map("albers", lat0 = 30, lat1 = 40) +
  viridis::scale_fill_viridis(option = "B") +
  ggtitle("Enrollment per 10,000 Population in 2014") +
  ggthemes::theme_map() +
  theme(legend.position = c(.85, .3),
        legend.title=element_blank())

en_county_2015 %>% 
  mutate(countygeoid = sprintf("%05.0f", countygeoid)) %>% 
  arrange(countygeoid) -> en_county_2015

usmapdata::county %>% 
  left_join(en_county_2015, by = c("id" = "countygeoid")) -> en_county_2015_map

ggplot() +
  geom_map(data = en_county_2015_map, map = en_county_2015_map,
           aes(x = long, y = lat, map_id = id, fill = enroll_per100000),
           colour = alpha("white", 0.1), size=0.2) +
  geom_map(data = usmapdata::state, map = usmapdata::state,
           aes(x = long, y = lat, map_id = id),
           colour = "white", fill = "NA") +
  coord_map("albers", lat0 = 30, lat1 = 40) +
  viridis::scale_fill_viridis(option = "B") +
  ggtitle("Enrollment per 10,000 Population in 2015") +
  ggthemes::theme_map() +
  theme(legend.position = c(.85, .3),
        legend.title=element_blank())
```


## Total enrollment by states

```{r, message=FALSE, warning=FALSE}
# 2014
qhp::enrollment2014 %>% 
  na.omit() %>% 
  group_by(state) %>% 
  summarise(statename = first(StateName),
            enrollment = sum(PlanSelections)) %>% 
  arrange(enrollment %>% desc) %>% 
  print(n = 36)

# 2015
qhp::enrollment2015 %>% 
  na.omit() %>% 
  group_by(state) %>% 
  summarise(statename = first(StateName),
            enrollment = sum(PlanSelections)) %>% 
  arrange(enrollment %>% desc) %>% 
  print(n = 37)
```

## Health Plan Data

```{r, message=FALSE, warning=FALSE}
qhp::qhp2014
```
